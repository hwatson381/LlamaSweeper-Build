(function(){"use strict";class _{constructor(t,s,i,e,n,o){this.premiumsMap=new Map,this.xReverse=t,this.yReverse=s,this.xySwap=i,this.width=e,this.height=n,this.excludeNegativePremiums=o}addPremium(t,s,i){if(this.excludeNegativePremiums&&i<0)return;let e=this.xyToOrder(t,s),n=this.premiumsMap.get(i);if(!Array.isArray(n))this.premiumsMap.set(i,[e]);else{let o=this.sortedIndex(n,e);n.splice(o,0,e)}}lazyAddPremium(t,s,i){if(this.excludeNegativePremiums&&i<0)return;let e=this.xyToOrder(t,s),n=this.premiumsMap.get(i);Array.isArray(n)?n.push(e):this.premiumsMap.set(i,[e])}sortAfterLazyAdd(){for(let t of this.premiumsMap.values())t.sort((s,i)=>s-i)}removePremium(t,s,i){if(this.excludeNegativePremiums&&i<0)return;let e=this.xyToOrder(t,s),n=this.premiumsMap.get(i),o=this.sortedIndex(n,e);if(n[o]!==e)throw new Error("Order not found in premiums array?");n.splice(o,1),n.length===0&&this.premiumsMap.delete(i)}updatePremium(t,s,i,e){i!==e&&(this.removePremium(t,s,i),this.addPremium(t,s,e))}getHighestPremium(){if(this.premiumsMap.size===0){if(this.excludeNegativePremiums)return{x:"not stored",y:"not stored",premium:-1};throw new Error("Empty map")}const t=Math.max.apply(null,[...this.premiumsMap.keys()]);let s=this.premiumsMap.get(t)[0],{x:i,y:e}=this.orderToXy(s);return{x:i,y:e,premium:t}}xyToOrder(t,s){let i=this.xReverse?this.width-1-t:t,e=this.yReverse?this.height-1-s:s;return this.xySwap?e+this.height*i:i+this.width*e}orderToXy(t){let s,i;this.xySwap?(i=t%this.height,s=Math.floor(t/this.height)):(s=t%this.width,i=Math.floor(t/this.width));let e=this.xReverse?this.width-1-s:s,n=this.yReverse?this.height-1-i:i;return{x:e,y:n}}sortedIndex(t,s){for(var i=0,e=t.length;i<e;){var n=i+e>>>1;t[n]<s?i=n+1:e=n}return i}}class S{static createWomBoardDataObject(t,s,i){const e=t.length,n=t[0].length,{numbersArray:o,openingLabels:f,preprocessedOpenings:l}=s;let c=[],r=[],a=[],h=[];for(let p=0;p<e;p++)for(let y=0;y<n;y++){let m=o[p][y]==="x"?10:o[p][y];c.push(m),r.push(0),a.push(0),h.push(!1)}for(let[p,y]of l.entries()){for(let m of y.zeros){let w=m.y+m.x*n;r[w]=p}for(let m of y.edges){let w=m.y+m.x*n;r[w]===0?(r[w]=p,h[w]=!0):a[w]=p}}let u={f:[],g:r,g2:a,o:[],t:c};return i&&(u.womOpeningEdgesArray=h),u}static c215(t,s,i,e,n){if(typeof window<"u"&&!("Uint8Array"in window))return{total:0,clicks:[]};let o=i*e-n,f=0,l=[],c=!1,r={t:new Uint8Array(i*e),f:new Uint8Array(i*e),o:new Uint8Array(i*e),g:new Uint8Array(i*e),g2:new Uint8Array(i*e),p:new Int8Array(i*e)};for(let a=0;a<i*e;a++)r.t[a]=s.t[a],r.f[a]=0,r.o[a]=0,r.g[a]=s.g[a],r.g2[a]=s.g2[a],r.p[a]=0,r.t[a]==11&&(r.t[a]=10);if(s.womOpeningEdgesArray&&(r.womOpeningEdgesArray=s.womOpeningEdgesArray.slice(0)),t){let a=[];for(let h=0;h<i;h++)for(let u=0;u<e;u++)r.g[h*e+u]&&(!a.includes(r.g[h*e+u])&&r.t[h*e+u]===0&&(a.push(r.g[h*e+u]),l.push({type:"left",x:h,y:u})),r.o[h*e+u]=1,o--),r.g[h*e+u]>f&&(f=r.g[h*e+u]);c=!0}for(let a=0;a<i;a++)for(let h=0;h<e;h++)r.p[a*e+h]=this.c216(a,h,i,e,r);for(;o>0;){let a=this.g250(t,i,e,r);if(a.premiumBestIndexes.length>0&&a.premiumBestValue>=0){let h=a.premiumBestIndexes[0];if(a.premiumBestIndexes.length>1){let m=-1;for(let w=0;w<a.premiumBestIndexes.length;w++){let x=a.premiumBestIndexes[w]/e|0,g=a.premiumBestIndexes[w]%e,d={t:r.t,o:r.o.slice(0),f:r.f.slice(0),g:r.g,g2:r.g2,p:r.p.slice(0)};this.p104(x,g,i,e,d);let b=this.g250(t,i,e,d),A=b.premiumBestValue*1e3+b.premiumBestIndexes.length;A>m&&(h=a.premiumBestIndexes[w],m=A)}}let u=h/e|0,p=h%e,y=this.p104(u,p,i,e,r);f+=y.zini,o+=y.needToOpenCount,l=l.concat(y.clicks)}else{let h=!1;if(!c){for(let u=0;u<i&&!h;u++)for(let p=0;p<e&&!h;p++)!r.o[u*e+p]&&r.t[u*e+p]==0&&(o-=this.o68(u,p,i,e,r),f++,h=!0,l.push({type:"left",x:u,y:p}));h||(c=!0)}if(c){h=!1;for(let u=0;u<i&&!h;u++)for(let p=0;p<e&&!h;p++)r.t[u*e+p]!=10&&!r.o[u*e+p]&&!(r.g2[u*e+p]&&r.t[u*e+p]>0)&&(o-=this.o68(u,p,i,e,r),f++,h=!0,l.push({type:"left",x:u,y:p}));if(!h)return{total:f,clicks:l}}}}return{total:f,clicks:l}}static g250(t,s,i,e){let n={premiumBestIndexes:[],premiumBestValue:-100};for(let o=0;o<s*i;o++)t&&!e.o[o]||(e.p[o]>n.premiumBestValue?(n.premiumBestIndexes=[o],n.premiumBestValue=e.p[o]):e.p[o]==n.premiumBestValue&&n.premiumBestIndexes.push(o));return n}static p104(t,s,i,e,n){let o={needToOpenCount:0,zini:0,clicks:[]};return n.o[t*e+s]||(o.needToOpenCount-=this.o68(t,s,i,e,n),o.zini++,o.clicks.push({type:"left",x:t,y:s})),o.zini++,t-1>=0&&s-1>=0&&(n.t[(t-1)*e+(s-1)]==10&&!n.f[(t-1)*e+(s-1)]&&(this.m108(t-1,s-1,i,e,n),o.zini++,o.clicks.push({type:"right",x:t-1,y:s-1})),n.t[(t-1)*e+(s-1)]!=10&&!n.o[(t-1)*e+(s-1)]&&(o.needToOpenCount-=this.o68(t-1,s-1,i,e,n))),s-1>=0&&(n.t[t*e+(s-1)]==10&&!n.f[t*e+(s-1)]&&(this.m108(t,s-1,i,e,n),o.zini++,o.clicks.push({type:"right",x:t,y:s-1})),n.t[t*e+(s-1)]!=10&&!n.o[t*e+(s-1)]&&(o.needToOpenCount-=this.o68(t,s-1,i,e,n))),t+1<i&&s-1>=0&&(n.t[(t+1)*e+(s-1)]==10&&!n.f[(t+1)*e+(s-1)]&&(this.m108(t+1,s-1,i,e,n),o.zini++,o.clicks.push({type:"right",x:t+1,y:s-1})),n.t[(t+1)*e+(s-1)]!=10&&!n.o[(t+1)*e+(s-1)]&&(o.needToOpenCount-=this.o68(t+1,s-1,i,e,n))),t-1>=0&&(n.t[(t-1)*e+s]==10&&!n.f[(t-1)*e+s]&&(this.m108(t-1,s,i,e,n),o.zini++,o.clicks.push({type:"right",x:t-1,y:s})),n.t[(t-1)*e+s]!=10&&!n.o[(t-1)*e+s]&&(o.needToOpenCount-=this.o68(t-1,s,i,e,n))),t+1<i&&(n.t[(t+1)*e+s]==10&&!n.f[(t+1)*e+s]&&(this.m108(t+1,s,i,e,n),o.zini++,o.clicks.push({type:"right",x:t+1,y:s})),n.t[(t+1)*e+s]!=10&&!n.o[(t+1)*e+s]&&(o.needToOpenCount-=this.o68(t+1,s,i,e,n))),t-1>=0&&s+1<e&&(n.t[(t-1)*e+(s+1)]==10&&!n.f[(t-1)*e+(s+1)]&&(this.m108(t-1,s+1,i,e,n),o.zini++,o.clicks.push({type:"right",x:t-1,y:s+1})),n.t[(t-1)*e+(s+1)]!=10&&!n.o[(t-1)*e+(s+1)]&&(o.needToOpenCount-=this.o68(t-1,s+1,i,e,n))),s+1<e&&(n.t[t*e+(s+1)]==10&&!n.f[t*e+(s+1)]&&(this.m108(t,s+1,i,e,n),o.zini++,o.clicks.push({type:"right",x:t,y:s+1})),n.t[t*e+(s+1)]!=10&&!n.o[t*e+(s+1)]&&(o.needToOpenCount-=this.o68(t,s+1,i,e,n))),t+1<i&&s+1<e&&(n.t[(t+1)*e+(s+1)]==10&&!n.f[(t+1)*e+(s+1)]&&(this.m108(t+1,s+1,i,e,n),o.zini++,o.clicks.push({type:"right",x:t+1,y:s+1})),n.t[(t+1)*e+(s+1)]!=10&&!n.o[(t+1)*e+(s+1)]&&(o.needToOpenCount-=this.o68(t+1,s+1,i,e,n))),o.clicks.push({type:"chord",x:t,y:s}),o}static c216(t,s,i,e,n){if(n.t[t*e+s]==0||n.t[t*e+s]==10)return-100;let o=0;return n.o[t*e+s]||(o-=1),o-=1,n.g[t*e+s]||(o+=1),t-1>=0&&s-1>=0&&(n.t[(t-1)*e+(s-1)]==10?n.f[(t-1)*e+(s-1)]||o--:!n.o[(t-1)*e+(s-1)]&&!n.g[(t-1)*e+(s-1)]&&o++),s-1>=0&&(n.t[t*e+(s-1)]==10?n.f[t*e+(s-1)]||o--:!n.o[t*e+(s-1)]&&!n.g[t*e+(s-1)]&&o++),t+1<i&&s-1>=0&&(n.t[(t+1)*e+(s-1)]==10?n.f[(t+1)*e+(s-1)]||o--:!n.o[(t+1)*e+(s-1)]&&!n.g[(t+1)*e+(s-1)]&&o++),t-1>=0&&(n.t[(t-1)*e+s]==10?n.f[(t-1)*e+s]||o--:!n.o[(t-1)*e+s]&&!n.g[(t-1)*e+s]&&o++),t+1<i&&(n.t[(t+1)*e+s]==10?n.f[(t+1)*e+s]||o--:!n.o[(t+1)*e+s]&&!n.g[(t+1)*e+s]&&o++),t-1>=0&&s+1<e&&(n.t[(t-1)*e+(s+1)]==10?n.f[(t-1)*e+(s+1)]||o--:!n.o[(t-1)*e+(s+1)]&&!n.g[(t-1)*e+(s+1)]&&o++),s+1<e&&(n.t[t*e+(s+1)]==10?n.f[t*e+(s+1)]||o--:!n.o[t*e+(s+1)]&&!n.g[t*e+(s+1)]&&o++),t+1<i&&s+1<e&&(n.t[(t+1)*e+(s+1)]==10?n.f[(t+1)*e+(s+1)]||o--:!n.o[(t+1)*e+(s+1)]&&!n.g[(t+1)*e+(s+1)]&&o++),n.womOpeningEdgesArray?o+=this.countUnopenedOpeningsTouchingCell(t,s,i,e,n):n.g2[t*e+s]&&(t-1>=0&&s-1>=0&&n.t[(t-1)*e+(s-1)]==0&&!n.o[(t-1)*e+(s-1)]||s-1>=0&&n.t[t*e+(s-1)]==0&&!n.o[t*e+(s-1)]||t+1<i&&s-1>=0&&n.t[(t+1)*e+(s-1)]==0&&!n.o[(t+1)*e+(s-1)]||t-1>=0&&n.t[(t-1)*e+s]==0&&!n.o[(t-1)*e+s]||t+1<i&&n.t[(t+1)*e+s]==0&&!n.o[(t+1)*e+s]||t-1>=0&&s+1<e&&n.t[(t-1)*e+(s+1)]==0&&!n.o[(t-1)*e+(s+1)]||s+1<e&&n.t[t*e+(s+1)]==0&&!n.o[t*e+(s+1)]||t+1<i&&s+1<e&&n.t[(t+1)*e+(s+1)]==0&&!n.o[(t+1)*e+(s+1)])&&o++,o}static countUnopenedOpeningsTouchingCell(t,s,i,e,n){if(!n.womOpeningEdgesArray)throw new Error("womOpeningEdgesArray undefined, but countOpeningsTouchingCell was called");if(n.womOpeningEdgesArray[t*e+s]===!1)return 0;let o=[{x:t-1,y:s-1},{x:t-1,y:s},{x:t-1,y:s+1},{x:t,y:s-1},{x:t,y:s+1},{x:t+1,y:s-1},{x:t+1,y:s},{x:t+1,y:s+1}];o=o.filter(l=>l.x>=0&&l.x<i&&l.y>=0&&l.y<e);let f=[];for(let l of o)if(!n.o[l.x*e+l.y]&&n.t[l.x*e+l.y]===0){let c=n.g[l.x*e+l.y];f.includes(c)||f.push(c)}return f.length}static o68(t,s,i,e,n){let o=1;if(n.o[t*e+s]=1,n.t[t*e+s]==0){for(let f=0;f<i;f++)for(let l=0;l<e;l++)(n.g[f*e+l]==n.g[t*e+s]||n.g2[f*e+l]==n.g[t*e+s])&&!(f==t&&l==s)&&(n.o[f*e+l]||(n.o[f*e+l]=1,o++,n.t[f*e+l]!=0&&n.p[f*e+l]++),n.t[f*e+l]!=0&&n.p[f*e+l]--);return o}return n.p[t*e+s]++,n.g[t*e+s]||n.p[t*e+s]--,n.g[t*e+s]||(t-1>=0&&s-1>=0&&n.p[(t-1)*e+(s-1)]--,s-1>=0&&n.p[t*e+(s-1)]--,t+1<i&&s-1>=0&&n.p[(t+1)*e+(s-1)]--,t-1>=0&&n.p[(t-1)*e+s]--,t+1<i&&n.p[(t+1)*e+s]--,t-1>=0&&s+1<e&&n.p[(t-1)*e+(s+1)]--,s+1<e&&n.p[t*e+(s+1)]--,t+1<i&&s+1<e&&n.p[(t+1)*e+(s+1)]--),o}static m108(t,s,i,e,n){n.f[t*e+s]=1,t-1>=0&&s-1>=0&&n.p[(t-1)*e+(s-1)]++,s-1>=0&&n.p[t*e+(s-1)]++,t+1<i&&s-1>=0&&n.p[(t+1)*e+(s-1)]++,t-1>=0&&n.p[(t-1)*e+s]++,t+1<i&&n.p[(t+1)*e+s]++,t-1>=0&&s+1<e&&n.p[(t-1)*e+(s+1)]++,s+1<e&&n.p[t*e+(s+1)]++,t+1<i&&s+1<e&&n.p[(t+1)*e+(s+1)]++}}const v=Object.freeze({UNREVEALED:"unrevealed",FLAG:"flag",MINE:"mine",MINERED:"minered",MINEWRONG:"minewrong"});class Z{constructor(){throw new Error("Algorithms class only has static methods, and cannot be instantiated")}static calcBasicZini(t,s,i=!1,e=!1,n=!1){i||(i=this.getNumbersArrayAndOpeningLabelsAndPreprocessedOpenings(t));const{numbersArray:o,openingLabels:f,preprocessedOpenings:l}=i,c=t.length,r=t[0].length;let a;e?a=e:a=new Array(c).fill(0).map(()=>new Array(r).fill(!1));let h;n?h=n:h=new Array(c).fill(0).map(()=>new Array(r).fill(!1));const u=this.computeSquareInfo(t,o,f),p=new Array(c).fill(0).map(()=>new Array(r).fill(null));for(let g=0;g<c;g++)for(let d=0;d<r;d++)t[g][d]||this.updatePremiumForCoord(g,d,u,h,a,p,l);let y=0;for(let g=0;g<c;g++)for(let d=0;d<r;d++)!t[g][d]&&!a[g][d]&&y++;let m;s?m=[[!1,!1,!1],[!0,!1,!1],[!1,!0,!1],[!0,!0,!1],[!1,!1,!0],[!0,!1,!0],[!1,!0,!0],[!0,!0,!0]]:m=[[!1,!1,!1]];let w=1/0,x=null;for(const g of m){const d=[],b=this.fast2dArrayCopy(h),A=this.fast2dArrayCopy(a),U=this.fast2dArrayCopy(p);let I=0;const P=new _(g[0],g[1],g[2],c,r,!0);for(let M=0;M<c;M++)for(let C=0;C<r;C++)t[M][C]||P.lazyAddPremium(M,C,p[M][C]);P.sortAfterLazyAdd();let F=!1;for(;I!==y;){let M=this.doBasicZiniStep(u,b,A,U,l,d,g[0],g[1],g[2],P);if(I+=M.newlyRevealed,M.onlyNFRemaining){F=!0;break}}F&&this.nfClickEverythingForZini(u,A,l,d),d.length<w&&(w=d.length,x=d)}return{total:w,clicks:x}}static doBasicZiniStep(t,s,i,e,n,o,f,l,c,r=!1){const a=i.length,h=i[0].length;let u=0,p=-1,y=null,m=null;if(r){const{x,y:g,premium:d}=r.getHighestPremium();m={x,y:g},p=d}else{const x=f?a-1:0,g=f?0:a-1,d=l?h-1:0,b=l?0:h-1,A=c?d:x,U=c?b:g,I=c?x:d,P=c?g:b,F=c?l:f,M=c?f:l;for(let C=A;F?C>=0:C<=U;F?C--:C++)for(let T=I;M?T>=0:T<=P;M?T--:T++){const[E,N]=c?[T,C]:[C,T],V=t[E][N];V.isMine||(y===null&&V.is3bv&&(i[E][N]||(y={x:E,y:N})),p<e[E][N]&&(p=e[E][N],m={x:E,y:N}))}}if(r&&p<=-1)return{newlyRevealed:0,onlyNFRemaining:!0};let w=[];if(m===null){if(y===null)throw new Error("No chords or NF clicks found?");if(i[y.x][y.y])throw new Error("Square already revealed? Should never happen");o.push({type:"left",x:y.x,y:y.y}),i[y.x][y.y]=!0,u++;for(let g of t[y.x][y.y].safeNeighbours)w.push({x:g.x,y:g.y});const x=t[y.x][y.y].labelIfOpening;if(x!==null){const g=n.get(x);for(let d of g.zeros)i[d.x][d.y]||(i[d.x][d.y]=!0,u++);for(let d of g.edges)i[d.x][d.y]||(i[d.x][d.y]=!0,u++),w.push({x:d.x,y:d.y})}}else{const x=t[m.x][m.y],g=x.mineNeighbours.filter(b=>!s[b.x][b.y]);i[m.x][m.y]||(o.push({type:"left",x:m.x,y:m.y}),i[m.x][m.y]=!0,u++);for(let b of g)o.push({type:"right",x:b.x,y:b.y}),s[b.x][b.y]=!0;o.push({type:"chord",x:m.x,y:m.y});const d=[...x.openingsTouched].map(b=>n.get(b)).filter(b=>{const A=b.zeros[0];return!i[A.x][A.y]});for(let b of d){for(let A of b.zeros)i[A.x][A.y]||(i[A.x][A.y]=!0,u++);for(let A of b.edges)i[A.x][A.y]||(i[A.x][A.y]=!0,u++),w.push({x:A.x,y:A.y})}for(let b of x.safeNeighbours)i[b.x][b.y]||(i[b.x][b.y]=!0,u++);for(let b=m.x-2;b<=m.x+2;b++)for(let A=m.y-2;A<=m.y+2;A++)w.push({x:b,y:A})}w=w.filter((x,g,d)=>g===d.findIndex(b=>b.x===x.x&&b.y===x.y));for(let x of w)this.updatePremiumForCoord(x.x,x.y,t,s,i,e,n,r);return{newlyRevealed:u,onlyNFRemaining:!1}}static computeSquareInfo(t,s,i){const e=t.length,n=t[0].length,o=new Array(e).fill(0).map(()=>new Array(n).fill(0).map(()=>({isMine:!1,number:null,is3bv:null,labelIfOpening:null,mineNeighbours:[],safeNeighbours:[],nonOpening3bvNeighbours:[],openingsTouched:new Set})));for(let f=0;f<e;f++)for(let l=0;l<n;l++){const c=o[f][l];if(t[f][l]){c.isMine=!0;continue}c.number=s[f][l],i[f][l]===0||s[f][l]===0?c.is3bv=!0:c.is3bv=!1,s[f][l]===0&&(c.labelIfOpening=i[f][l]);for(let r=f-1;r<=f+1;r++)for(let a=l-1;a<=l+1;a++)if(!(r<0||r>=e||a<0||a>=n)&&!(r===f&&a===l)){if(t[r][a]){c.mineNeighbours.push({x:r,y:a});continue}else c.safeNeighbours.push({x:r,y:a});i[r][a]===0?c.nonOpening3bvNeighbours.push({x:r,y:a}):typeof i[r][a]=="number"&&s[f][l]!==0&&c.openingsTouched.add(i[r][a])}}return o}static nfClickEverythingForZini(t,s,i,e){const n=s.length,o=s[0].length;for(let f=0;f<n;f++)for(let l=0;l<o;l++){const c=t[f][l];if(c.isMine||s[f][l]||!c.is3bv)continue;e.push({type:"left",x:f,y:l}),s[f][l]=!0;const r=t[f][l].labelIfOpening;if(r!==null){const a=i.get(r);for(let h of a.zeros)s[h.x][h.y]=!0;for(let h of a.edges)s[h.x][h.y]=!0}}}static calcEightWayZini(t,s=!1,i=!1,e=!1){return this.calcBasicZini(t,!0,s,i,e)}static calcOneWayZini(t,s=!1){return this.calcBasicZini(t,!1,s)}static updatePremiumForCoord(t,s,i,e,n,o,f,l=!1){const c=n.length,r=n[0].length;if(t<0||t>=c||s<0||s>=r)return;const a=i[t][s];if(a.isMine)return;if(a.number===0){o[t][s]=-1;return}let h=0;for(let x of a.nonOpening3bvNeighbours)n[x.x][x.y]||h++;let u=0;for(let x of a.openingsTouched){const g=f.get(x).zeros[0];n[g.x][g.y]||u++}let p=0;for(let x of a.mineNeighbours)e[x.x][x.y]||p++;const y=h+u;let m=0;!a.is3bv&&!n[t][s]&&(m=1);const w=y-p-1-m;l&&l.updatePremium(t,s,o[t][s],w),o[t][s]=w}static getNumbersArrayAndOpeningLabelsAndPreprocessedOpenings(t){var l;const s=t.length,i=t[0].length,e=new Array(s).fill(0).map(()=>new Array(i).fill(0));for(let c=0;c<s;c++)for(let r=0;r<i;r++)if(!!t[c][r]){e[c][r]="x";for(let a=c-1;a<=c+1;a++)for(let h=r-1;h<=r+1;h++)((l=t[a])==null?void 0:l[h])===!1&&e[a][h]++}let n=new Array(s).fill(0).map(()=>new Array(i).fill(0)),o=0;const f=new Map;for(let c=0;c<s;c++)for(let r=0;r<i;r++){if(t[c][r]){n[c][r]="x";continue}if(e[c][r]===0&&n[c][r]===0){o++;let a={zeros:[],edges:[]};f.set(o,a),this.floodOpeningForProcessing(c,r,t,n,e,f,o)}}return{numbersArray:e,openingLabels:n,preprocessedOpenings:f}}static floodOpeningForProcessing(t,s,i,e,n,o,f){var l;if(((l=e[t])==null?void 0:l[s])!==void 0&&e[t][s]!==f)if(n[t][s]!==0){e[t][s]="+";const c=o.get(f);c.edges.some(r=>r.x===t&&r.y===s)||c.edges.push({x:t,y:s});return}else n[t][s]===0&&(e[t][s]=f,o.get(f).zeros.push({x:t,y:s}),this.floodOpeningForProcessing(t-1,s-1,i,e,n,o,f),this.floodOpeningForProcessing(t-1,s,i,e,n,o,f),this.floodOpeningForProcessing(t-1,s+1,i,e,n,o,f),this.floodOpeningForProcessing(t,s-1,i,e,n,o,f),this.floodOpeningForProcessing(t,s+1,i,e,n,o,f),this.floodOpeningForProcessing(t+1,s-1,i,e,n,o,f),this.floodOpeningForProcessing(t+1,s,i,e,n,o,f),this.floodOpeningForProcessing(t+1,s+1,i,e,n,o,f))}static calc3bv(t,s=!1,i=!1){const e=t.length,n=t[0].length;let o;i?o=i.openingLabels:o=this.getNumbersArrayAndOpeningLabelsAndPreprocessedOpenings(t).openingLabels;const f=new Set(o.flat().filter(a=>typeof a=="number"&&a!==0)).size,l=o.flat().filter(a=>a===0).length;let c=f+l,r=0;if(s){let a=0,h=new Set;for(let u=0;u<e;u++)for(let p=0;p<n;p++)typeof s[u][p].state=="number"&&(o[u][p]===0?a++:typeof o[u][p]=="number"&&h.add(o[u][p]));r=a+h.size}return{bbbv:c,solved3bv:r}}static fast2dArrayCopy(t){return t.map(s=>s.slice())}static fisherYatesArrayShuffle(t,s=!1){s||(s=Math.random);for(var i=t.length,e,n;--i>0;)e=Math.floor(s()*(i+1)),n=t[e],t[e]=t[i],t[i]=n}static basicShuffle(t,s,i,e=null,n=!1){let o=[];if(e&&(o.push({x:e.x,y:e.y}),n))for(let r=e.x-1;r<=e.x+1;r++)for(let a=e.y-1;a<=e.y+1;a++)r===e.x&&a===e.y||r>=0&&r<=t-1&&a>=0&&a<=s-1&&o.push({x:r,y:a});if(t*s-o.length<i)if(t*s-1>=i)o=[{x:e.x,y:e.y}];else throw new Error(`Cannot generate ${t}x${s}/${i}`);const f=new Array(t*s-o.length).fill(!1);for(let r=0;r<i;r++)f[r]=!0;this.fisherYatesArrayShuffle(f);const l=new Array(t).fill(0).map(()=>new Array(s).fill(!1));let c=0;for(let r=0;r<t;r++)for(let a=0;a<s;a++)o.some(h=>h.x===r&&h.y===a)||(l[r][a]=f[c],c++);return l}static effBoardShuffle(t,s,i,e,n,o){const f=performance.now();let l=!1;for(;!l;){if(performance.now()-f>o*1e3)return!1;let c=this.basicShuffle(t,s,i,e,!0),r=this.getNumbersArrayAndOpeningLabelsAndPreprocessedOpenings(c);const a=this.calc3bv(c,!1,r).bbbv,h=this.calcBasicZini(c,!1,r).total;let u=a/(a-(a-h)*1.15-2)>=n/100;if(a/(h-this.get99thPercentileSubzini(t,s,i,a,h))>=n/100,u){const p=this.calcBasicZini(c,!0,r).total;a/p>=n/100&&(l=c)}}return l}static get99thPercentileSubzini(t,s,i,e,n){const o=`${t}-${s}-${i}`;let f=null;switch(o){case"9-9-10":f=[5,9,14,25,40,1/0];break;case"16-16-40":f=[0,0,0,33,70,90,100,110,120,1/0];break;case"30-16-99":f=[0,0,0,0,0,0,0,170,200,216,222,227,230,235,1/0];break;default:f=null}if(f){let l=0;for(let c=0;c<f.length;c++)if(e<=f[c]){l=c;break}return l}else return(e-n)*.15+2}static getRandomZeroCell(t){let s=this.getNumbersArrayAndOpeningLabelsAndPreprocessedOpenings(t).numbersArray,i=t.length,e=t[0].length,n=[];for(let o=0;o<i;o++)for(let f=0;f<e;f++)s[o][f]===0&&n.push({x:o,y:f});if(n.length===0)for(;;){let o=Math.floor(Math.random()*i),f=Math.floor(Math.random()*e);if(!t[o][f])return{x:o,y:f}}return n[Math.floor(Math.random()*n.length)]}static calcWomZiniAndHZini(t,s=!1){const i=this.getNumbersArrayAndOpeningLabelsAndPreprocessedOpenings(t);let e=S.createWomBoardDataObject(t,i,s);const n=t.length,o=t[0].length,f=t.flat().filter(h=>h).length;let{total:l,clicks:c}=S.c215(!1,e,n,o,f),{total:r,clicks:a}=S.c215(!0,e,n,o,f);return l>r&&(l=r,c=structuredClone(a)),{womZini:{total:l,clicks:c},womHzini:{total:r,clicks:a}}}static reorderZiniClicks(t,s){t=structuredClone(t);const i=s.length,e=s[0].length,{numbersArray:n,openingLabels:o,preprocessedOpenings:f}=this.getNumbersArrayAndOpeningLabelsAndPreprocessedOpenings(s);let l={opening:[],setupClick:[],flags:[],chords:[],cleanup:[]};for(let c of t){if(c.type==="left"){if(n[c.x][c.y]===0){l.opening.push(c);continue}let r=null;for(let h=c.x-1;h<=c.x+1;h++){let u=!1;for(let p=c.y-1;p<=c.y+1;p++)if(!(h<0||h>=i||p<0||p>=e)&&n[h][p]===0){r={x:h,y:p},u=!0;break}if(u)break}if(r){c.x=r.x,c.y=r.y,l.opening.push(c);continue}if(t.some(h=>h.type==="chord"&&h.x===c.x&&h.y===c.y)){l.setupClick.push(c);continue}else{l.cleanup.push(c);continue}}if(c.type==="right"){l.flags.push(c);continue}if(c.type==="chord"){l.chords.push(c);continue}}return t=[...l.opening,...l.setupClick,...l.flags,...l.chords,...l.cleanup],t}static getPttaMinesString(t){const s=t.length,i=t[0].length;let e="";const n=s*i;for(var o=0;o<n;o+=5){for(var f=0,l=o;l<o+5;l++)l>=n||t[l%s][Math.floor(l/s)]===!1?f*=2:(f*=2,f++);e+=f.toString(32)}return e}static getPttaDimensionString(t){const s=t.length,i=t[0].length;let e;if(s===9&&i===9)e="1";else if(s===16&&i===16)e="2";else if(s===30&&i===16)e="3";else{let n=s.toString().length;e=s.toString()+i.toString().padStart(n,"0")}return e}static encodeClicks(t,s,i){const e=new $,n={left:0,right:1,chord:2},o=Math.ceil(Math.log2(s*i));t.forEach(c=>{const r=n[c.type],a=c.x*i+c.y;e.writeBits(r,2),e.writeBits(a,o)}),e.writeBits(3,2);let f=e.getBytes(),l=String.fromCharCode(...f);return btoa(l).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}static decodeClicks(t,s,i){try{const n=(t+"===".slice((t.length+3)%4)).replace(/-/g,"+").replace(/_/g,"/"),o=atob(n),f=Uint8Array.from(o,h=>h.charCodeAt(0)),l=new L(f),c={0:"left",1:"right",2:"chord"},r=Math.ceil(Math.log2(s*i)),a=[];for(;l.bitPos+2<f.length*8;){const h=l.readBits(2);if(h===3)break;const u=l.readBits(r),p=Math.floor(u/i),y=u%i;if(p>=s||y>=i)return!1;a.push({type:c[h],x:p,y})}return a}catch{return!1}}static getCompressedData(t,s){const i=s.length,e=s[0].length,n=s.flat().filter(u=>u).length;let o="";for(let u=0;u<e;u++)for(let p=0;p<i;p++){const y=t[p][u];if(s[p][u]&&y.state===v.FLAG)y.state===v.FLAG?o=o+"F":o=o+"H";else if(typeof y.state=="number"){const m=y.state;let w=0;for(let x=p-1;x<=p+1;x++)for(let g=u-1;g<=u+1;g++)x<0||x>=i||g<0||g>=e||x===p&&g===u||s[x][g]&&t[x][g].state===v.FLAG&&w++;if(w>m)throw new Error(`Tile at x: ${p}, y: ${u} has too many flags around it, can't compress invalid data`);o=o+(m-w)}else o=o+"H"}const f=new q;let l=f.compressNumber(i,2),c=f.compressNumber(e,2),r=f.compressNumber(n,4),a=f.compress(o),h=l+c+r+a;return console.log("Compressed data length "+h.length+" analysis="+h),{width:i,height:e,mineCount:n,analysis:h}}}class ${constructor(){this.bits=[],this.bitPos=0}writeBits(t,s){for(let i=s-1;i>=0;i--){const e=t>>i&1,n=Math.floor(this.bitPos/8),o=7-this.bitPos%8;this.bits[n]===void 0&&(this.bits[n]=0),this.bits[n]|=e<<o,this.bitPos++}}getBytes(){return new Uint8Array(this.bits)}}class L{constructor(t){this.bytes=t,this.bitPos=0}readBits(t){let s=0;for(let i=0;i<t;i++){const e=Math.floor(this.bitPos/8),n=7-this.bitPos%8,o=this.bytes[e]>>n&1;s=s<<1|o,this.bitPos++}return s}}class q{constructor(){this.BASE62="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",this.VALUES=["0","1","2","3","4","5","6","7","8","I","H","F","O"],this.BASES=[10,7,5,5,4,3,3,1,1,4,10,8,1],this.digits=[];let t=0;for(const s of this.BASES)this.digits.push(this.BASE62.substring(t,t+s)),t=t+s}compress(t){let s="",i=0,e="";for(let n=0;n<t.length;n++){let o=t.charAt(n);e==""?(e=o,i=1):o==e?i++:(s=s+this.compressFragment(e,i),e=o,i=1)}return s=s+this.compressFragment(e,i),s}compressFragment(t,s){let i=this.VALUES.indexOf(t);if(i==-1)return console.log("Unable to find the value '"+t+"' in the compression values array"),"";let e=this.digits[i],n=e.length;if(n==1)return e.repeat(s);let o="";for(;s!=0;){let f=s%n;o=e[f]+o,s=(s-f)/n}return o}decompress(t){let s="",i=0,e="";for(let n=0;n<t.length;n++){let o=t.charAt(n),f=this.digits.findIndex(a=>a.includes(o)),l=this.VALUES[f],c=this.digits[f].indexOf(o),r=this.digits[f].length;e==""?(e=l,i=c):l==e?r==1?i++:i=i*r+c:(s=s+e.repeat(i),e=l,r==1?i=1:i=c)}return s=s+e.repeat(i),s}compressNumber(t,s){const i=this.BASE62.length;let e="";for(let n=0;n<s;n++){let o=t%i;e=this.BASE62[o]+e,t=(t-o)/i}return e}decompressNumber(t){const s=this.BASE62.length;let i=0;for(let e=0;e<t.length;e++){let n=this.BASE62.indexOf(t.charAt(e));i=i*s+n}return i}}const W="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let D=W.charAt(Math.floor(Math.random()*W.length));console.log(`worker ${D} initialised`);let B=!0,k={width:null,height:null,mineCount:null,targetEff:null},z="random",R=null;const K=5,X=2;onmessage=function(O){if(O.data.command==="process")G(O);else if(O.data.command==="pause")H();else if(O.data.command==="updateFirstClickType")Y(O);else throw new Error("unrecognised command received in worker")};function G(O){k.width=O.data.width,k.height=O.data.height,k.mineCount=O.data.mineCount,k.targetEff=O.data.targetEff,B&&Q()}function H(){B||(clearTimeout(R),B=!0)}function Y(O){["corner","middle","random"].includes(O.data.firstClickType)?z=O.data.firstClickType:z="random"}function Q(){B&&(R=setTimeout(j,0),B=!1)}function j(){let O=!1,t=[],i=performance.now()/1e3+X,e=null;switch(z){case"corner":e={x:0,y:0};break;case"middle":e={x:Math.floor(k.width/2),y:Math.floor(k.height/2)};break;case"same":case"random":default:e=null}for(;!(performance.now()/1e3>i);){let n=Z.effBoardShuffle(k.width,k.height,k.mineCount,e,k.targetEff,Math.max(i-performance.now()/1e3,.1));if(n&&(e===null&&(e=Z.getRandomZeroCell(n)),t.push({mines:n,firstClick:e,firstClickType:z}),t.length>=K)){O=!0;break}}t.length>0&&J(t),B||(R=setTimeout(j,O?500:0))}function J(O){const t=`${k.width}-${k.height}-${k.mineCount}-${k.targetEff}`;postMessage({boardKey:t,workerId:D,foundBoards:O})}})();
